--= CONFIGURAÇÃO INICIAL =--
local mon = peripheral.find("monitor")
if not mon then
    print("Nenhum monitor encontrado!")
    return
end

mon.setTextScale(0.5)
local w, h = mon.getSize()
local centerX, centerY = math.floor(w / 2), math.floor(h / 2)

--= PALETA DE CORES PSICODÉLICAS =--
local COLORS = {
    colors.purple,
    colors.magenta,
    colors.pink,
    colors.blue,
    colors.cyan,
    colors.red
}

--= CONFIGURAÇÕES DE ANIMAÇÃO =--
local COLOR_CHANGE_SPEED = 0.5  -- Velocidade de mudança de cor (mais rápido)
local PUPIL_SIZE = 3
local IRIS_SIZE = 10
local EYE_WIDTH = 30
local EYE_HEIGHT = 18
local MOVE_SPEED = 0.2  -- Movimento mais rápido para balada

--= ESTADO DO OLHO =--
local eye = {
    currentColor = colors.purple,
    nextColor = colors.magenta,
    colorProgress = 0,
    look = {x = 0, y = 0, targetX = 0, targetY = 0},
    moveTimer = 0
}

--= FUNÇÃO DE DESENHO SIMPLES =--
local function drawPixel(x, y, color)
    mon.setBackgroundColor(color)
    mon.setCursorPos(centerX + x, centerY + y)
    mon.write(" ")
end

--= FUNÇÃO DE DESENHO DE ELIPSE OTIMIZADA =--
local function drawEllipse(x, y, rx, ry, color)
    local rx2 = rx * rx
    local ry2 = ry * ry
    for dy = -ry, ry do
        local dxLimit = math.sqrt(rx2 * (1 - (dy*dy)/ry2))
        for dx = -dxLimit, dxLimit do
            drawPixel(math.floor(x + dx), math.floor(y + dy), color)
        end
    end
end

--= ATUALIZAÇÃO DE COR (SEM BLEND) =--
local function updateColor(dt)
    eye.colorProgress = eye.colorProgress + dt * COLOR_CHANGE_SPEED
    
    if eye.colorProgress >= 1 then
        eye.colorProgress = 0
        eye.currentColor = eye.nextColor
        
        -- Próxima cor aleatória, mas diferente da atual
        local newIndex
        repeat
            newIndex = math.random(#COLORS)
        until COLORS[newIndex] ~= eye.currentColor
        
        eye.nextColor = COLORS[newIndex]
    end
end

--= MOVIMENTO RÁPIDO DA ÍRIS =--
local function updateMovement(dt)
    eye.moveTimer = eye.moveTimer + dt
    if eye.moveTimer >= 0.3 then  -- Muda direção frequentemente
        eye.moveTimer = 0
        eye.look.targetX = math.random(-12, 12)
        eye.look.targetY = math.random(-8, 8)
    end
    
    -- Movimento rápido e direto
    eye.look.x = eye.look.x + (eye.look.targetX - eye.look.x) * MOVE_SPEED
    eye.look.y = eye.look.y + (eye.look.targetY - eye.look.y) * MOVE_SPEED
end

--= DESENHO DO OLHO =--
local function drawEye()
    -- Esclera (parte branca do olho)
    drawEllipse(0, 0, EYE_WIDTH, EYE_HEIGHT, colors.white)
    
    -- Íris (cor atual ou próxima cor baseado no progresso)
    local irisColor = eye.colorProgress > 0.5 and eye.nextColor or eye.currentColor
    drawEllipse(eye.look.x, eye.look.y, IRIS_SIZE, IRIS_SIZE, irisColor)
    
    -- Pupila
    drawEllipse(eye.look.x, eye.look.y, PUPIL_SIZE, PUPIL_SIZE, colors.black)
    
    -- Reflexo destacado
    drawPixel(eye.look.x - 3, eye.look.y - 3, colors.white)
    drawPixel(eye.look.x - 2, eye.look.y - 4, colors.white)
end

--= LOOP PRINCIPAL =--
local lastTime = os.epoch("utc")
while true do
    local currentTime = os.epoch("utc")
    local dt = (currentTime - lastTime) / 1000
    lastTime = currentTime
    
    mon.setBackgroundColor(colors.black)
    mon.clear()
    
    updateColor(dt)
    updateMovement(dt)
    drawEye()
    
    sleep(0.05)  -- ~20 FPS
end
