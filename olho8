-- olho_gigante_v7.lua (choro com base azul + bravo fixo colorido)

local mon
for _, nome in ipairs(peripheral.getNames()) do
  if peripheral.getType(nome) == "monitor" then
    mon = peripheral.wrap(nome)
    break
  end
end

if not mon then
  print("Nenhum monitor encontrado!")
  return
end

mon.setTextScale(0.5)
local w, h = mon.getSize()
local cx, cy = math.floor(w / 2), math.floor(h / 2)

local cores = {
  colors.red, colors.orange, colors.yellow,
  colors.lime, colors.green, colors.blue,
  colors.cyan, colors.purple, colors.pink, colors.magenta
}

local posicoes = {
  {x = 0, y = 0}, {x = -6, y = 0}, {x = 6, y = 0},
  {x = 0, y = -4}, {x = 0, y = 4},
  {x = -4, y = -2}, {x = 4, y = -2},
  {x = -4, y = 2}, {x = 4, y = 2}
}

-- Variáveis para lágrimas
local lagrimas_colunas = {}
local lagrimas_pos = {}
local lagrimas_max_altura = h - 1

do
  local startX = cx - 20
  for i = 1, 10 do
    lagrimas_colunas[i] = startX + (i * 4)
    lagrimas_pos[i] = math.random(0, 8)
  end
end

local tremendo = false
local tremor_timer = 0

-- Desenha a esclera (parte branca) normal ou azulada se chorar
local function desenharEsclera(baseX, baseY, chora)
  for y = -14, 14 do
    for x = -26, 26 do
      if (x * x) / 676 + (y * y) / 196 <= 1 then
        mon.setCursorPos(baseX + x, baseY + y)
        if chora and y >= 8 and y <= 14 then
          -- faixa azul suave na parte inferior se chorar
          mon.setBackgroundColor(colors.lightBlue)
        else
          mon.setBackgroundColor(colors.white)
        end
        mon.write(" ")
      end
    end
  end
end

local function desenharOlho(offsetX, offsetY, cor, emoc, tremorDeslocX, tremorDeslocY)
  tremorDeslocX = tremorDeslocX or 0
  tremorDeslocY = tremorDeslocY or 0

  mon.setBackgroundColor(colors.black)
  mon.clear()

  local baseX = cx + tremorDeslocX
  local baseY = cy + tremorDeslocY

  local chora = (emoc == "triste")

  desenharEsclera(baseX, baseY, chora)

  -- Íris
  for y = -8, 8 do
    for x = -12, 12 do
      if (x * x) / 144 + (y * y) / 64 <= 1 then
        mon.setCursorPos(baseX + x + offsetX, baseY + y + offsetY)
        mon.setBackgroundColor(cor)
        mon.write(" ")
      end
    end
  end

  -- Pupila
  for y = -2, 2 do
    for x = -2, 2 do
      mon.setCursorPos(baseX + x + offsetX, baseY + y + offsetY)
      mon.setBackgroundColor(colors.black)
      mon.write(" ")
    end
  end

  -- Emoções específicas
  if emoc == "bravo" then
    -- Fundo da esclera fica escuro (cinza escuro)
    for y = -14, 14 do
      for x = -26, 26 do
        if (x * x) / 676 + (y * y) / 196 <= 1 then
          mon.setCursorPos(baseX + x, baseY + y)
          mon.setBackgroundColor(colors.gray)
          mon.write(" ")
        end
      end
    end
    -- Íris fixa, centro (offset 0,0) com cor pulsante vermelha/laranja
    local pulseColors = {colors.red, colors.orange, colors.red}
    local pulseCor = pulseColors[math.floor(os.clock() * 2) % #pulseColors + 1]

    for y = -8, 8 do
      for x = -12, 12 do
        if (x * x) / 144 + (y * y) / 64 <= 1 then
          mon.setCursorPos(baseX + x, baseY + y)
          mon.setBackgroundColor(pulseCor)
          mon.write(" ")
        end
      end
    end
    -- Pupila central fixa
    for y = -2, 2 do
      for x = -2, 2 do
        mon.setCursorPos(baseX + x, baseY + y)
        mon.setBackgroundColor(colors.black)
        mon.write(" ")
      end
    end

  elseif emoc == "triste" then
    -- Desenha lágrimas escorrendo em múltiplas colunas na parte inferior do olho
    for i = 1, #lagrimas_colunas do
      local col = lagrimas_colunas[i] + tremorDeslocX
      local baseY_lagrima = cy + 14 + lagrimas_pos[i] + tremorDeslocY

      if baseY_lagrima <= h then
        mon.setCursorPos(col, baseY_lagrima)
        mon.setBackgroundColor(colors.blue)
        mon.write(" ")
      end
    end
  elseif emoc == "assustado" then
    -- Olho branco com íris cinza clara e pupila pequena
    for y = -8, 8 do
      for x = -12, 12 do
        mon.setCursorPos(baseX + x + offsetX, baseY + y + offsetY)
        mon.setBackgroundColor(colors.white)
        mon.write(" ")
      end
    end
    for y = -3, 3 do
      for x = -3, 3 do
        mon.setCursorPos(baseX + x + offsetX, baseY + y + offsetY)
        mon.setBackgroundColor(colors.lightGray)
        mon.write(" ")
      end
    end
    for y = -1, 1 do
      for x = -1, 1 do
        mon.setCursorPos(baseX + x + offsetX, baseY + y + offsetY)
        mon.setBackgroundColor(colors.black)
        mon.write(" ")
      end
    end
  end
end

local function escolherEmocao()
  local chance = math.random()
  if chance < 0.05 then
    local emos = {"bravo", "triste", "assustado"}
    return emos[math.random(#emos)]
  end
  return nil
end

local emoc_atual = nil
local emoc_timer = 0

while true do
  if emoc_atual then
    emoc_timer = emoc_timer - 0.4
    if emoc_timer <= 0 then
      emoc_atual = nil
      tremendo = false
    end
  else
    emoc_atual = escolherEmocao()
    if emoc_atual then
      emoc_timer = 30 + math.random(10)
      tremendo = (emoc_atual == "bravo")
      tremor_timer = 0
    end
  end

  local pupila = posicoes[math.random(#posicoes)]
  local cor = cores[math.random(#cores)]

  local tremorX, tremorY = 0, 0
  if tremendo then
    tremor_timer = tremor_timer + 1
    if tremor_timer <= 12 then
      tremorX = math.random(-1,1)
      tremorY = math.random(-1,1)
    else
      tremendo = false
    end
  end

  desenharOlho(pupila.x, pupila.y, cor, emoc_atual, tremorX, tremorY)

  if emoc_atual == "triste" then
    for i = 1, #lagrimas_pos do
      lagrimas_pos[i] = lagrimas_pos[i] + 1
      if lagrimas_pos[i] > lagrimas_max_altura then
        lagrimas_pos[i] = 0
      end
    end
  end

  sleep(0.4)
end
    end
  end

  sleep(0.4)
end
