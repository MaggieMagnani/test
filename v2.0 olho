--= OLHO EMOCIONAL ULTRA REALISTA =--
-- Por: Seu Nome (com ajuda da IA)
-- Versão: Masterpiece 2.0

--= CONFIGURAÇÃO INICIAL =--
local mon = peripheral.find("monitor")
if not mon then error("Monitores não encontrados!") end

mon.setTextScale(0.5)
local w, h = mon.getSize()
local centerX, centerY = math.floor(w/2), math.floor(h/2)

--= SISTEMA DE EMOÇÕES AVANÇADO =--
local EMOTIONS = {
    CALMO = {
        blink = 0.003,
        duration = {min=300, max=500}, -- 30-50 segundos
        iris = {color="dynamic", size=3},
        sclera = {color=colors.white, redness=0},
        effects = {background="none", particles="none"}
    },
    RAIVA = {
        blink = 0.02,
        duration = {min=350, max=450}, -- 35-45 segundos
        iris = {color=colors.red, size=2.5},
        sclera = {color=colors.white, redness=0.4},
        effects = {background="pulse", particles="veins"},
        sound = "angry"
    },
    ESTRESSADO = {
        blink = 0.04,
        duration = {min=250, max=350},
        iris = {color="dynamic", size=3.5},
        sclera = {color=colors.white, redness=0.2},
        effects = {background="glitch", particles="static"}
    },
    MEDO = {
        blink = 0.06,
        duration = {min=400, max=500},
        iris = {color=colors.gray, size=1.8},
        sclera = {color=colors.lightGray, redness=0},
        effects = {background="static", particles="shiver"}
    },
    TRISTE = {
        blink = 0.01,
        duration = {min=450, max=600},
        iris = {color=colors.blue, size=4},
        sclera = {color=colors.white, redness=0},
        effects = {background="rain", particles="tears"},
        tearIntensity = 0.5
    },
    CHORANDO = {
        blink = 0.005,
        duration = {min=500, max=700},
        iris = {color=colors.blue, size=4.5},
        sclera = {color=colors.lightBlue, redness=0},
        effects = {background="heavyRain", particles="waterfall"},
        tearIntensity = 1.0
    }
}

--= SISTEMA DE PARTÍCULAS =--
local PARTICLES = {
    veins = {
        count = 60,
        color = colors.red,
        thickness = {1,3},
        speed = 0.1,
        life = 100
    },
    tears = {
        count = 120,
        colors = {colors.blue, colors.lightBlue, colors.cyan},
        size = {1,4},
        speed = {1,3},
        spawnRate = 0.7
    },
    static = {
        count = 200,
        colors = {colors.white, colors.lightGray},
        life = {5,15}
    }
}

--= ESTADO DO OLHO =--
local eye = {
    emotion = "CALMO",
    timer = 0,
    blink = 0,
    look = {x=0, y=0},
    particles = {},
    waterLevel = 0,
    redness = 0,
    effects = {
        background = {},
        particles = {}
    }
}

--= FUNÇÕES DE INICIALIZAÇÃO =--
local function initParticles()
    -- Sistema modular de partículas
    eye.particles = {
        veins = {},
        tears = {},
        static = {}
    }
    
    for i = 1, PARTICLES.veins.count do
        eye.particles.veins[i] = {
            x1 = math.random(-30,30), y1 = math.random(-20,20),
            x2 = math.random(-30,30), y2 = math.random(-20,20),
            life = PARTICLES.veins.life,
            thickness = math.random(PARTICLES.veins.thickness[1], PARTICLES.veins.thickness[2])
        }
    end
    
    for i = 1, PARTICLES.tears.count do
        eye.particles.tears[i] = {
            active = false,
            x = 0, y = 0,
            size = math.random(PARTICLES.tears.size[1], PARTICLES.tears.size[2]),
            color = PARTICLES.tears.colors[math.random(#PARTICLES.tears.colors)],
            speed = math.random(PARTICLES.tears.speed[1], PARTICLES.tears.speed[2])
        }
    end
end

initParticles()

--= SISTEMA DE DESENHO =--
local function drawPixel(x,y,color)
    mon.setBackgroundColor(color)
    mon.setCursorPos(centerX + x, centerY + y)
    mon.write(" ")
end

local function drawEllipse(x,y,rx,ry,color)
    for dy = -ry, ry do
        for dx = -rx, rx do
            if (dx*dx)/(rx*rx) + (dy*dy)/(ry*ry) <= 1 then
                drawPixel(x+dx, y+dy, color)
            end
        end
    end
end

--= EFEITOS VISUAIS =--
local EFFECTS = {
    pulse = {
        radius = math.max(w,h)/2 + 5,
        intensity = 0,
        update = function(self)
            self.intensity = (self.intensity + 0.07) % (math.pi*2)
        end,
        draw = function(self)
            local pulse = math.floor((math.sin(self.intensity)+1)*4)
            for a = 0, 360, 5 do
                local rad = math.rad(a)
                local x = math.floor(math.cos(rad)*self.radius)
                local y = math.floor(math.sin(rad)*self.radius)
                for i = 1, pulse do
                    drawPixel(x,y, colors.red)
                end
            end
        end
    },
    rain = {
        drops = {},
        update = function(self)
            for i = 1, 40 do
                if not self.drops[i] or self.drops[i].y > h/2+10 then
                    self.drops[i] = {
                        x = math.random(-w,w),
                        y = -h/2-5,
                        speed = math.random(2,4),
                        size = math.random(1,2)
                    }
                else
                    self.drops[i].y = self.drops[i].y + self.drops[i].speed
                end
            end
        end,
        draw = function(self)
            for _, drop in ipairs(self.drops) do
                local dist = math.sqrt(drop.x^2 + drop.y^2)
                if dist > math.max(w,h)/2+3 and dist < math.max(w,h)/2+8 then
                    for i = 0, drop.size do
                        drawPixel(drop.x, drop.y+i, colors.blue)
                    end
                end
            end
        end
    }
}

--= ATUALIZAÇÃO DO ESTADO =--
local function updateEmotion()
    eye.timer = eye.timer - 1
    if eye.timer <= 0 then
        local nextEmotion = weightedRandom({
            CALMO = 60,
            RAIVA = 10,
            ESTRESSADO = 12,
            MEDO = 8,
            TRISTE = 7,
            CHORANDO = 3
        })
        setEmotion(nextEmotion)
    end
end

local function weightedRandom(weights)
    local total = 0
    for _, w in pairs(weights) do total = total + w end
    local r = math.random(total)
    local sum = 0
    for e, w in pairs(weights) do
        sum = sum + w
        if r <= sum then return e end
    end
end

local function setEmotion(newEmotion)
    eye.emotion = newEmotion
    local e = EMOTIONS[newEmotion]
    eye.timer = math.random(e.duration.min, e.duration.max)
    eye.effects.background = EFFECTS[e.effects.background] or {}
    -- Resetar partículas ao mudar de emoção
    if e.effects.particles == "tears" then
        eye.waterLevel = 0
    end
end

--= LOOP PRINCIPAL =--
while true do
    mon.setBackgroundColor(colors.black)
    mon.clear()
    
    updateEmotion()
    local current = EMOTIONS[eye.emotion]
    
    -- Atualizar efeitos
    if eye.effects.background.update then
        eye.effects.background:update()
    end
    
    -- Desenhar fundo
    if eye.effects.background.draw then
        eye.effects.background:draw()
    end
    
    -- Desenhar olho
    drawEye()
    
    sleep(0.1)
end
