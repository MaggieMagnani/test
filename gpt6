--= CONFIGURAÇÃO INICIAL =--
local mon = peripheral.find("monitor")
if not mon then
    print("Nenhum monitor encontrado!")
    return
end

mon.setTextScale(0.5)
local w, h = mon.getSize()
local centerX, centerY = math.floor(w / 2), math.floor(h / 2)

--= PALETA DE CORES PSICODÉLICAS =--
local COLORS = {
    colors.purple,
    colors.magenta,
    colors.pink,
    colors.blue,
    colors.cyan,
    colors.red
}

--= TAMANHO DO OLHO =--
local EYE_RADIUS_X = 18
local EYE_RADIUS_Y = 12
local IRIS_RADIUS = 5
local PUPIL_RADIUS = 2

--= ANIMAÇÃO =--
local eye = {
    irisColor = colors.purple,
    nextColor = colors.magenta,
    colorProgress = 0,
    look = {x = 0, y = 0, tx = 0, ty = 0},
    moveTimer = 0
}
local COLOR_SPEED = 0.5
local MOVE_SPEED = 0.2

--= FUNÇÃO SEGURA PARA DESENHAR PIXEL =--
local function drawPixel(x, y, color)
    local px = centerX + x
    local py = centerY + y
    if px >= 1 and px <= w and py >= 1 and py <= h then
        mon.setBackgroundColor(color)
        mon.setCursorPos(px, py)
        mon.write(" ")
    end
end

--= DESENHA UMA ELIPSE =--
local function drawEllipse(cx, cy, rx, ry, color)
    for dy = -ry, ry do
        local dxLimit = math.floor(rx * math.sqrt(1 - (dy * dy) / (ry * ry)))
        for dx = -dxLimit, dxLimit do
            drawPixel(cx + dx, cy + dy, color)
        end
    end
end

--= ANIMAÇÃO DE COR =--
local function updateColor(dt)
    eye.colorProgress = eye.colorProgress + dt * COLOR_SPEED
    if eye.colorProgress >= 1 then
        eye.colorProgress = 0
        eye.irisColor = eye.nextColor
        repeat
            eye.nextColor = COLORS[math.random(#COLORS)]
        until eye.nextColor ~= eye.irisColor
    end
end

--= MOVIMENTO LATERAL SUAVE =--
local function updateLook(dt)
    eye.moveTimer = eye.moveTimer + dt
    if eye.moveTimer >= 0.5 then
        eye.moveTimer = 0
        eye.look.tx = math.random(-5, 5)
        eye.look.ty = math.random(-3, 3)
    end
    eye.look.x = eye.look.x + (eye.look.tx - eye.look.x) * MOVE_SPEED
    eye.look.y = eye.look.y + (eye.look.ty - eye.look.y) * MOVE_SPEED
end

--= DESENHA O OLHO =--
local function drawEye()
    -- Fundo preto
    mon.setBackgroundColor(colors.black)
    mon.clear()

    -- Esclera
    drawEllipse(0, 0, EYE_RADIUS_X, EYE_RADIUS_Y, colors.white)

    -- Íris
    local irisColor = eye.colorProgress < 0.5 and eye.irisColor or eye.nextColor
    drawEllipse(eye.look.x, eye.look.y, IRIS_RADIUS, IRIS_RADIUS, irisColor)

    -- Pupila
    drawEllipse(eye.look.x, eye.look.y, PUPIL_RADIUS, PUPIL_RADIUS, colors.black)

    -- Reflexo
    drawPixel(eye.look.x - 2, eye.look.y - 2, colors.white)
end

--= LOOP PRINCIPAL =--
local lastTime = os.epoch("utc")
while true do
    local now = os.epoch("utc")
    local dt = (now - lastTime) / 1000
    lastTime = now

    updateColor(dt)
    updateLook(dt)
    drawEye()

    sleep(0.05)
end
